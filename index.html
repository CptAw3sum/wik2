<html manifest="wik.manifest1">

<head>
    <meta charset="UTF-8">
    <!-- Disable zoom-on-edit in certain mobile browsers -->
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, user-scalable=0" />
    <style>
        body,
        textarea {
            font-family: Consolas, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace;
            font-size: 20px;
        }
        
        textarea {
            border: none;
            overflow: auto;
            outline: none;
            -webkit-box-shadow: none;
            -moz-box-shadow: none;
            box-shadow: none;
        }
            
        .title-bar {
            margin-bottom: 20px;
            font-size: 30px;
        }
        
        #title {
            
            color: #F00;
        }
        
        .button {
            float: right;
            text-decoration: none;
            background-color: #555;
            color: #FFF;
            width: 35px;
            height: 35px;
            text-align: center;
            margin-left: 5px;
        }
    </style>

</head>

<body>
    <div class="title-bar">
        <a id="back" class="button" href="javascript:history.back()"><</a>
            <a id="settings" class="button" href="javascript:history.back()">#</a>
        <span id="title"></span>
    </div>
    <textarea id="editor" style="width:100%" rows="20" spellcheck="false">
    </textarea>
    <div class="settings">
        <div><a href="#System:Export">Import/Export</a>
        </div>
        <div><a href="javascript:deleteAll()">Delete all</a>
        </div>
    </div>
    <script>
        var DATA_KEY = 'wik.data';
        var SYSTEM_EXPORT_PAGE = 'System:Export';
        var DEFAULT_CONTENT = "Welcome to wik!\n\n" + //
            "Go ahead and edit this page.\n\n" + //
            "Changes are automatically saved.\n\n" + //
            "Brackets create links, e.g. (Banana)\n\n" + //
            "Click or press return inside a link to open it.\n"

        var page;
        var pages;
        editor = document.getElementById('editor');

        document.addEventListener("DOMContentLoaded", function (event) {
            load();
            enterPage('Home');
        });

        function load() {
            var rawData = localStorage.getItem(DATA_KEY);
            if (!rawData) {
                setDefaultContent();
            } else {
                pages = JSON.parse(rawData);
            }
        }

        function enterPage(pageName) {
            page = pageName;            
            window.location.hash = pageName;
            editor.value = pageText();
            document.getElementById('title').innerHTML = page;
            editor.blur();
        }
        
        function pageText(){
            if (page == SYSTEM_EXPORT_PAGE){
                return JSON.stringify(pages, undefined, 4);
            }
            else {
                var data = pages[page];
                if (data == undefined){
                    data = '';
                }
                return data;
            }
        }

        window.onhashchange = function () {
            var pageName = window.location.hash.substring(1);
            enterPage(pageName);
        }

        function save() {
            if (page == SYSTEM_EXPORT_PAGE){
                pages = JSON.parse(editor.value);
            }
            else {
                pages[page] = editor.value;
            }
            localStorage.setItem(DATA_KEY, JSON.stringify(pages));
        }

        editor.onkeydown = navigate;
        editor.onkeyup = edit;
        editor.onclick = navigate;

        function edit(){
            save();
        }
        
        function navigate(e) {
            if (page == SYSTEM_EXPORT_PAGE){
                return;
            }
            var linkUnderCursor = null;
            var text = editor.value;
            var cursor = editor.selectionStart;
            var linkStart, linkEnd;
            for (var i = 0; i < text.length; i++) {
                var c = text.charAt(i);
                if (c == '[' || c == '(') {
                    linkStart = i;
                }
                if (c == ']' || c == ')') {
                    if (linkStart != null) {
                        linkEnd = i;
                    }
                    if (linkStart < cursor && cursor <= linkEnd) {
                        break;
                    } else {
                        linkStart = null;
                        linkEnd = null;
                    }
                }
            }
            if (linkStart != null) {
                linkUnderCursor = text.substring(linkStart + 1, linkEnd);
            }
            var isLinkEnter = (e.type == 'click' || e.keyCode == 13);
            if (isLinkEnter && linkUnderCursor) { // return
                e.preventDefault();
                enterPage(linkUnderCursor);
            }
        }

        function setDefaultContent() {
            pages = {
                "Home": DEFAULT_CONTENT
            }
        }

        function deleteAll() {
            var response = window.confirm("This will delete all of your data. Are you sure?");
            if (response){
                setDefaultContent();
                enterPage('Home');
                save();
            }
        }
        
        function exportPages(){
            enterPage(SYSTEM_EXPORT_PAGE);
        }
        
            
        
    </script>
</body>
<html>